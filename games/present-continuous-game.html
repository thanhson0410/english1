<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Present Continuous Game - Luy·ªán T·∫≠p Th√¨ Hi·ªán T·∫°i Ti·∫øp Di·ªÖn</title>
    <link rel="stylesheet" href="../style.css">
    <style>
        .time-indicator {
            background: linear-gradient(135deg, #ff6b6b 0%, #feca57 100%);
            color: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 10px;
            text-align: center;
            font-weight: bold;
            animation: timeGlow 2s infinite ease-in-out;
        }
        
        @keyframes timeGlow {
            0%, 100% { box-shadow: 0 0 10px rgba(255,107,107,0.5); }
            50% { box-shadow: 0 0 20px rgba(255,107,107,0.8); }
        }
        
        .verb-form-display {
            background: #f8f9fa;
            border: 3px solid #28a745;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
            font-family: 'Courier New', monospace;
            font-size: 1.2em;
            font-weight: bold;
        }
        
        .subject-verb-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .subject-option {
            background: #e3f2fd;
            border: 3px solid #2196f3;
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            min-height: 80px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        .subject-option:hover {
            border-color: #1976d2;
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(33,150,243,0.3);
        }
        
        .subject-option.selected {
            border-color: #1976d2;
            background: #bbdefb;
            transform: scale(1.05);
        }
        
        .subject-option.correct {
            border-color: #4caf50;
            background: #c8e6c9;
            animation: correctBounce 0.6s ease;
        }
        
        .subject-option.incorrect {
            border-color: #f44336;
            background: #ffcdd2;
            animation: shake 0.5s ease;
        }
        
        @keyframes correctBounce {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-8px); }
            75% { transform: translateX(8px); }
        }
        
        .ing-formation {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            position: relative;
        }
        
        .ing-formation::before {
            content: "üí° ING RULES";
            position: absolute;
            top: -12px;
            left: 15px;
            background: #ffc107;
            color: #333;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: bold;
        }
        
        .ing-rule {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 10px 0;
            padding: 10px;
            background: white;
            border-radius: 8px;
            border-left: 4px solid #ff9800;
        }
        
        .ing-rule .base {
            font-weight: bold;
            color: #d32f2f;
        }
        
        .ing-rule .arrow {
            color: #666;
            font-size: 1.2em;
        }
        
        .ing-rule .result {
            font-weight: bold;
            color: #1976d2;
        }
        
        .situation-context {
            background: linear-gradient(135deg, #e8f5e8 0%, #f0f8f0 100%);
            border-left: 5px solid #4caf50;
            padding: 20px;
            margin: 20px 0;
            border-radius: 0 12px 12px 0;
        }
        
        .situation-context h4 {
            color: #2e7d32;
            margin-bottom: 10px;
        }
        
        .picture-context {
            background: #f3e5f5;
            border: 3px solid #9c27b0;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
            position: relative;
        }
        
        .picture-context::before {
            content: "üì∏ PICTURE DESCRIPTION";
            position: absolute;
            top: -12px;
            left: 50%;
            transform: translateX(-50%);
            background: #9c27b0;
            color: white;
            padding: 6px 15px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: bold;
        }
        
        .picture-emoji {
            font-size: 3em;
            margin: 10px 0;
        }
        
        .sentence-building {
            background: white;
            border: 3px solid #ff5722;
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            min-height: 120px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        .sentence-parts {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            align-items: center;
            min-height: 60px;
        }
        
        .sentence-part {
            background: #ffecb3;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: bold;
            color: #e65100;
            border: 2px solid #ffc107;
        }
        
        .sentence-blank {
            background: #ffcdd2;
            padding: 8px 20px;
            border-radius: 20px;
            border: 3px dashed #f44336;
            color: #d32f2f;
            font-weight: bold;
            min-width: 100px;
            text-align: center;
            animation: blinkBorder 1.5s infinite ease-in-out;
        }
        
        @keyframes blinkBorder {
            0%, 100% { border-color: #f44336; }
            50% { border-color: #ff8a80; }
        }
        
        .negative-positive-toggle {
            display: flex;
            background: #f5f5f5;
            border-radius: 25px;
            padding: 5px;
            margin: 20px auto;
            max-width: 300px;
        }
        
        .toggle-option {
            flex: 1;
            padding: 12px 20px;
            text-align: center;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
        }
        
        .toggle-option.active {
            background: #2196f3;
            color: white;
            box-shadow: 0 3px 10px rgba(33,150,243,0.3);
        }
        
        .timer-circle {
            width: 60px;
            height: 60px;
            border: 4px solid #e0e0e0;
            border-top: 4px solid #2196f3;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px auto;
            position: relative;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .timer-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-weight: bold;
            color: #2196f3;
        }
        
        .quick-tip {
            background: #e1f5fe;
            border-left: 4px solid #0288d1;
            padding: 15px;
            margin: 15px 0;
            border-radius: 0 8px 8px 0;
            font-style: italic;
        }
        
        .quick-tip::before {
            content: "üí° ";
            font-style: normal;
        }
        
        @media (max-width: 768px) {
            .subject-verb-grid {
                grid-template-columns: 1fr;
            }
            
            .subject-option {
                min-height: 60px;
                padding: 15px;
            }
            
            .sentence-parts {
                flex-direction: column;
                gap: 15px;
            }
            
            .picture-emoji {
                font-size: 2.5em;
            }
            
            .verb-form-display {
                font-size: 1em;
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>‚è∞ Present Continuous Game</h1>
        <p>Luy·ªán T·∫≠p Th√¨ Hi·ªán T·∫°i Ti·∫øp Di·ªÖn</p>
        <nav>
            <ul>
                <li><a href="../index.html">üè† Trang Ch·ªß</a></li>
                <li><a href="../grammar-lessons/lessons.html">üìö B√†i H·ªçc</a></li>
                <li><a href="games.html">üéÆ Tr√≤ Ch∆°i</a></li>
            </ul>
        </nav>
    </header>

    <main>
        <section class="game-mode-selection" id="gameModeSection">
            <h2>üéØ Ch·ªçn Ch·∫ø ƒê·ªô Luy·ªán T·∫≠p</h2>
            <div class="game-mode-grid">
                <button class="game-mode-btn" onclick="startGame('basics')">
                    <h3>üéì C∆° B·∫£n</h3>
                    <p>am/is/are + V-ing</p>
                    <small>C√¥ng th·ª©c c∆° b·∫£n</small>
                </button>
                <button class="game-mode-btn" onclick="startGame('ing-rules')">
                    <h3>üìù Quy T·∫Øc -ing</h3>
                    <p>C√°ch th√™m -ing v√†o ƒë·ªông t·ª´</p>
                    <small>Spelling rules</small>
                </button>
                <button class="game-mode-btn" onclick="startGame('situations')">
                    <h3>üé≠ T√¨nh Hu·ªëng</h3>
                    <p>√Åp d·ª•ng v√†o ng·ªØ c·∫£nh th·ª±c t·∫ø</p>
                    <small>Real contexts</small>
                </button>
                <button class="game-mode-btn" onclick="startGame('pictures')">
                    <h3>üì∏ M√¥ T·∫£ H√¨nh ·∫¢nh</h3>
                    <p>M√¥ t·∫£ nh·ªØng g√¨ ƒëang x·∫£y ra</p>
                    <small>Visual description</small>
                </button>
                <button class="game-mode-btn" onclick="startGame('negative')">
                    <h3>‚ùå C√¢u Ph·ªß ƒê·ªãnh</h3>
                    <p>am/is/are + not + V-ing</p>
                    <small>Negative forms</small>
                </button>
                <button class="game-mode-btn" onclick="startGame('questions')">
                    <h3>‚ùì C√¢u H·ªèi</h3>
                    <p>Am/Is/Are + S + V-ing?</p>
                    <small>Question forms</small>
                </button>
            </div>
        </section>

        <section class="game-play" id="gamePlaySection" style="display: none;">
            <div class="game-stats">
                <div class="stat-card">
                    <h4>üìä ƒêi·ªÉm S·ªë</h4>
                    <div class="score" id="scoreDisplay">0</div>
                </div>
                <div class="stat-card">
                    <h4>‚ùì C√¢u H·ªèi</h4>
                    <div id="questionNumber">1/10</div>
                </div>
                <div class="stat-card">
                    <h4>üéØ ƒê·ªô Ch√≠nh X√°c</h4>
                    <div id="accuracyDisplay">100%</div>
                </div>
                <div class="stat-card">
                    <h4>üî• Streak</h4>
                    <div id="streakDisplay">0</div>
                </div>
            </div>

            <div class="time-indicator" id="timeIndicator">
                ‚è∞ RIGHT NOW - H√†nh ƒë·ªông ƒëang x·∫£y ra
            </div>

            <div class="question-container">
                <h3 id="questionText">Ch·ªçn ƒë√°p √°n ƒë√∫ng:</h3>
                
                <div class="situation-context" id="situationContext" style="display: none;">
                    <h4>üé≠ T√¨nh hu·ªëng:</h4>
                    <p id="situationText"></p>
                </div>
                
                <div class="picture-context" id="pictureContext" style="display: none;">
                    <div class="picture-emoji" id="pictureEmoji">üèÉ‚Äç‚ôÇÔ∏è</div>
                    <p id="pictureDescription">M√¥ t·∫£ nh·ªØng g√¨ b·∫°n th·∫•y trong h√¨nh</p>
                </div>

                <div class="sentence-building" id="sentenceBuilding">
                    <div class="sentence-parts" id="sentenceParts">
                        <span class="sentence-part" id="subjectPart">I</span>
                        <span class="sentence-blank" id="verbPart">_____</span>
                        <span class="sentence-part" id="objectPart">English</span>
                    </div>
                </div>

                <div class="verb-form-display" id="verbFormDisplay" style="display: none;">
                    Base Form: <span id="baseForm">work</span> ‚Üí Present Continuous: <span id="ingForm">?</span>
                </div>

                <div class="ing-formation" id="ingFormation" style="display: none;">
                    <div class="ing-rule">
                        <span class="base" id="ruleBase">work</span>
                        <span class="arrow">‚û°Ô∏è</span>
                        <span class="result" id="ruleResult">?</span>
                    </div>
                </div>

                <div class="negative-positive-toggle" id="sentenceTypeToggle" style="display: none;">
                    <div class="toggle-option active" data-type="positive">‚úÖ Kh·∫≥ng ƒê·ªãnh</div>
                    <div class="toggle-option" data-type="negative">‚ùå Ph·ªß ƒê·ªãnh</div>
                </div>

                <div class="subject-verb-grid" id="answerGrid"></div>

                <div class="quick-tip" id="quickTip" style="display: none;">
                    Nh·ªõ r·∫±ng Present Continuous di·ªÖn t·∫£ h√†nh ƒë·ªông ƒëang x·∫£y ra ngay b√¢y gi·ªù!
                </div>

                <div class="explanation-box" id="explanationBox" style="display: none;">
                    <h4>üí° Gi·∫£i Th√≠ch:</h4>
                    <p id="explanationText"></p>
                    <div id="grammarRule"></div>
                </div>

                <div class="game-controls">
                    <button class="btn btn-primary" id="nextBtn" onclick="nextQuestion()" style="display: none;">
                        C√¢u Ti·∫øp Theo ‚û°Ô∏è
                    </button>
                    <button class="btn btn-secondary" onclick="showHint()" id="hintBtn">
                        üí° G·ª£i √ù
                    </button>
                    <button class="btn btn-info" onclick="showIngRules()" id="rulesBtn">
                        üìù Quy T·∫Øc -ing
                    </button>
                </div>
            </div>
        </section>

        <section class="game-results" id="gameResultsSection" style="display: none;">
            <div class="results-container">
                <h2 id="resultsTitle">üéâ Ho√†n Th√†nh!</h2>
                <div class="final-score" id="finalScore"></div>
                <div class="star-rating" id="starRating"></div>
                
                <div class="results-stats">
                    <div class="result-stat">
                        <span>T·ªïng c√¢u h·ªèi:</span>
                        <span id="totalQuestions">10</span>
                    </div>
                    <div class="result-stat">
                        <span>Tr·∫£ l·ªùi ƒë√∫ng:</span>
                        <span id="correctAnswers">0</span>
                    </div>
                    <div class="result-stat">
                        <span>ƒê·ªô ch√≠nh x√°c:</span>
                        <span id="finalAccuracy">0%</span>
                    </div>
                    <div class="result-stat">
                        <span>Streak t·ªëi ƒëa:</span>
                        <span id="maxStreak">0</span>
                    </div>
                </div>

                <div class="achievements" id="achievementsDisplay"></div>

                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="resetGame()">üîÑ Ch∆°i L·∫°i</button>
                    <button class="btn btn-secondary" onclick="location.href='games.html'">üéÆ Game Kh√°c</button>
                    <button class="btn btn-secondary" onclick="location.href='../grammar-lessons/present-continuous.html'">üìö √în L√Ω Thuy·∫øt</button>
                </div>
            </div>
        </section>
    </main>

    <footer>
        <p>&copy; 2025 English Grammar Mastery - Present Continuous Game</p>
    </footer>

    <script>
        // Game variables
        let currentGameMode = '';
        let currentQuestion = 0;
        let score = 0;
        let correctAnswers = 0;
        let totalQuestions = 10;
        let streak = 0;
        let maxStreak = 0;
        let questions = [];
        let isAnswered = false;

        // Question sets for different game modes
        const questionSets = {
            basics: [
                {
                    subject: "I",
                    verb: "study",
                    object: "English now",
                    options: ["am studying", "is studying", "are studying", "study"],
                    correct: 0,
                    explanation: "'I' ƒëi v·ªõi 'am'. C√¥ng th·ª©c: I + am + V-ing",
                    rule: "I + am + V-ing"
                },
                {
                    subject: "She",
                    verb: "cook",
                    object: "dinner",
                    options: ["am cooking", "is cooking", "are cooking", "cook"],
                    correct: 1,
                    explanation: "'She' (s·ªë √≠t, ng√¥i th·ª© 3) ƒëi v·ªõi 'is'. C√¥ng th·ª©c: He/She/It + is + V-ing",
                    rule: "He/She/It + is + V-ing"
                },
                {
                    subject: "They",
                    verb: "play",
                    object: "football",
                    options: ["am playing", "is playing", "are playing", "play"],
                    correct: 2,
                    explanation: "'They' (s·ªë nhi·ªÅu) ƒëi v·ªõi 'are'. C√¥ng th·ª©c: You/We/They + are + V-ing",
                    rule: "You/We/They + are + V-ing"
                },
                {
                    subject: "We",
                    verb: "watch",
                    object: "TV",
                    options: ["am watching", "is watching", "are watching", "watch"],
                    correct: 2,
                    explanation: "'We' (s·ªë nhi·ªÅu) ƒëi v·ªõi 'are'.",
                    rule: "You/We/They + are + V-ing"
                },
                {
                    subject: "The cat",
                    verb: "sleep",
                    object: "on the sofa",
                    options: ["am sleeping", "is sleeping", "are sleeping", "sleep"],
                    correct: 1,
                    explanation: "'The cat' l√† s·ªë √≠t, ƒëi v·ªõi 'is'.",
                    rule: "Singular noun + is + V-ing"
                }
            ],
            'ing-rules': [
                {
                    baseForm: "work",
                    options: ["working", "workin", "workking", "works"],
                    correct: 0,
                    explanation: "ƒê·ªông t·ª´ th√¥ng th∆∞·ªùng: th√™m -ing tr·ª±c ti·∫øp.",
                    rule: "Consonant + vowel + consonant ‚Üí Th√™m -ing"
                },
                {
                    baseForm: "write",
                    options: ["writeing", "writing", "writting", "writes"],
                    correct: 1,
                    explanation: "ƒê·ªông t·ª´ k·∫øt th√∫c -e c√¢m: b·ªè -e, th√™m -ing.",
                    rule: "Verb ending in -e ‚Üí Drop -e, add -ing"
                },
                {
                    baseForm: "run",
                    options: ["runing", "running", "runng", "runs"],
                    correct: 1,
                    explanation: "ƒê·ªông t·ª´ 1 √¢m ti·∫øt, k·∫øt th√∫c CVC: g·∫•p ƒë√¥i ph·ª• √¢m cu·ªëi + ing.",
                    rule: "CVC pattern ‚Üí Double final consonant + -ing"
                },
                {
                    baseForm: "dance",
                    options: ["danceing", "dancing", "danccing", "dances"],
                    correct: 1,
                    explanation: "K·∫øt th√∫c -e: b·ªè -e, th√™m -ing.",
                    rule: "Verb ending in -e ‚Üí Drop -e, add -ing"
                },
                {
                    baseForm: "lie",
                    options: ["lieing", "lying", "liing", "lies"],
                    correct: 1,
                    explanation: "K·∫øt th√∫c -ie: ƒë·ªïi -ie th√†nh -y, th√™m -ing.",
                    rule: "Verb ending in -ie ‚Üí Change -ie to -y, add -ing"
                }
            ],
            situations: [
                {
                    situation: "B·∫°n ƒëang ·ªü th∆∞ vi·ªán v√† mu·ªën n√≥i v·ªõi b·∫°n b√® r·∫±ng b·∫°n ƒëang ƒë·ªçc s√°ch",
                    subject: "I",
                    verb: "read",
                    object: "a book",
                    options: ["am reading", "is reading", "are reading", "read"],
                    correct: 0,
                    explanation: "H√†nh ƒë·ªông ƒëang x·∫£y ra ngay b√¢y gi·ªù: I am reading a book.",
                    rule: "Present action happening now"
                },
                {
                    situation: "M·∫π b·∫°n ƒëang g·ªçi ƒëi·ªán v√† h·ªèi b·∫°n ƒëang l√†m g√¨. B·∫°n ƒëang xem TV",
                    subject: "I",
                    verb: "watch",
                    object: "TV",
                    options: ["am watching", "is watching", "are watching", "watch"],
                    correct: 0,
                    explanation: "Tr·∫£ l·ªùi v·ªÅ h√†nh ƒë·ªông hi·ªán t·∫°i: I am watching TV.",
                    rule: "Describing current activity"
                },
                {
                    situation: "B·∫°n nh√¨n th·∫•y c√°c b·∫°n h·ªçc sinh ƒëang ch∆°i b√≥ng ƒë√° ·ªü s√¢n tr∆∞·ªùng",
                    subject: "The students",
                    verb: "play",
                    object: "football",
                    options: ["am playing", "is playing", "are playing", "play"],
                    correct: 2,
                    explanation: "'The students' l√† s·ªë nhi·ªÅu, d√πng 'are playing'.",
                    rule: "Plural subject + are + V-ing"
                }
            ],
            pictures: [
                {
                    emoji: "üèÉ‚Äç‚ôÇÔ∏è",
                    description: "M·ªôt ng∆∞·ªùi ƒëang ch·∫°y",
                    subject: "The man",
                    verb: "run",
                    object: "",
                    options: ["am running", "is running", "are running", "run"],
                    correct: 1,
                    explanation: "M√¥ t·∫£ h√†nh ƒë·ªông trong h√¨nh: The man is running.",
                    rule: "Describing picture actions"
                },
                {
                    emoji: "üë©‚Äçüç≥",
                    description: "M·ªôt ph·ª• n·ªØ ƒëang n·∫•u ƒÉn",
                    subject: "The woman",
                    verb: "cook",
                    object: "",
                    options: ["am cooking", "is cooking", "are cooking", "cook"],
                    correct: 1,
                    explanation: "M√¥ t·∫£ h√†nh ƒë·ªông: The woman is cooking.",
                    rule: "Present action in progress"
                },
                {
                    emoji: "üë∂üò≠",
                    description: "M·ªôt em b√© ƒëang kh√≥c",
                    subject: "The baby",
                    verb: "cry",
                    object: "",
                    options: ["am crying", "is crying", "are crying", "cry"],
                    correct: 1,
                    explanation: "Em b√© (s·ªë √≠t): The baby is crying.",
                    rule: "Singular subject + is + V-ing"
                }
            ],
            negative: [
                {
                    subject: "I",
                    verb: "work",
                    object: "today",
                    isNegative: true,
                    options: ["am not working", "is not working", "are not working", "don't work"],
                    correct: 0,
                    explanation: "C√¢u ph·ªß ƒë·ªãnh: I am not working today.",
                    rule: "I + am + not + V-ing"
                },
                {
                    subject: "She",
                    verb: "listen",
                    object: "to music",
                    isNegative: true,
                    options: ["am not listening", "is not listening", "are not listening", "doesn't listen"],
                    correct: 1,
                    explanation: "C√¢u ph·ªß ƒë·ªãnh: She is not listening to music.",
                    rule: "He/She/It + is + not + V-ing"
                }
            ],
            questions: [
                {
                    question: "_____ you studying English?",
                    options: ["Am", "Is", "Are", "Do"],
                    correct: 2,
                    explanation: "C√¢u h·ªèi v·ªõi 'you': Are you studying English?",
                    rule: "Are + you + V-ing?"
                },
                {
                    question: "_____ she coming to the party?",
                    options: ["Am", "Is", "Are", "Does"],
                    correct: 1,
                    explanation: "C√¢u h·ªèi v·ªõi 'she': Is she coming to the party?",
                    rule: "Is + he/she/it + V-ing?"
                }
            ]
        };

        function startGame(mode) {
            currentGameMode = mode;
            currentQuestion = 0;
            score = 0;
            correctAnswers = 0;
            streak = 0;
            maxStreak = 0;
            
            questions = shuffleArray(questionSets[mode] || questionSets.basics);
            totalQuestions = 10;
            
            document.getElementById('gameModeSection').style.display = 'none';
            document.getElementById('gamePlaySection').style.display = 'block';
            
            updateTimeIndicator(mode);
            loadQuestion();
        }

        function updateTimeIndicator(mode) {
            const indicators = {
                'basics': '‚è∞ RIGHT NOW - H√†nh ƒë·ªông ƒëang x·∫£y ra',
                'ing-rules': 'üìù SPELLING RULES - Quy t·∫Øc th√™m -ing',
                'situations': 'üé≠ REAL SITUATIONS - T√¨nh hu·ªëng th·ª±c t·∫ø',
                'pictures': 'üì∏ PICTURE DESCRIPTION - M√¥ t·∫£ h√¨nh ·∫£nh',
                'negative': '‚ùå NEGATIVE FORMS - C√¢u ph·ªß ƒë·ªãnh',
                'questions': '‚ùì QUESTION FORMS - C√¢u h·ªèi'
            };
            
            document.getElementById('timeIndicator').textContent = indicators[mode];
        }

        function loadQuestion() {
            if (currentQuestion >= totalQuestions) {
                endGame();
                return;
            }
            
            isAnswered = false;
            const question = questions[currentQuestion];
            
            // Update UI
            document.getElementById('questionNumber').textContent = `${currentQuestion + 1}/${totalQuestions}`;
            document.getElementById('scoreDisplay').textContent = score;
            document.getElementById('accuracyDisplay').textContent = 
                Math.round((correctAnswers / Math.max(currentQuestion, 1)) * 100) + '%';
            document.getElementById('streakDisplay').textContent = streak;
            
            // Reset all displays
            hideAllContexts();
            
            // Show appropriate content based on game mode
            if (currentGameMode === 'ing-rules') {
                showIngRulesQuestion(question);
            } else if (currentGameMode === 'situations') {
                showSituationQuestion(question);
            } else if (currentGameMode === 'pictures') {
                showPictureQuestion(question);
            } else if (currentGameMode === 'questions') {
                showQuestionFormQuestion(question);
            } else {
                showBasicQuestion(question);
            }
            
            // Create answer options
            createAnswerOptions(question);
            
            // Hide explanation and next button
            document.getElementById('explanationBox').style.display = 'none';
            document.getElementById('nextBtn').style.display = 'none';
            document.getElementById('hintBtn').style.display = 'inline-block';
        }

        function hideAllContexts() {
            document.getElementById('situationContext').style.display = 'none';
            document.getElementById('pictureContext').style.display = 'none';
            document.getElementById('verbFormDisplay').style.display = 'none';
            document.getElementById('ingFormation').style.display = 'none';
            document.getElementById('sentenceTypeToggle').style.display = 'none';
            document.getElementById('quickTip').style.display = 'none';
        }

        function showBasicQuestion(question) {
            document.getElementById('questionText').textContent = "Ch·ªçn d·∫°ng ƒë√∫ng c·ªßa ƒë·ªông t·ª´:";
            
            const subjectPart = document.getElementById('subjectPart');
            const verbPart = document.getElementById('verbPart');
            const objectPart = document.getElementById('objectPart');
            
            subjectPart.textContent = question.subject;
            verbPart.textContent = "_____";
            objectPart.textContent = question.object;
            
            if (question.isNegative) {
                document.getElementById('sentenceTypeToggle').style.display = 'flex';
            }
        }

        function showIngRulesQuestion(question) {
            document.getElementById('questionText').textContent = "Th√™m -ing v√†o ƒë·ªông t·ª´ sau:";
            document.getElementById('verbFormDisplay').style.display = 'block';
            document.getElementById('ingFormation').style.display = 'block';
            
            document.getElementById('baseForm').textContent = question.baseForm;
            document.getElementById('ingForm').textContent = "?";
            document.getElementById('ruleBase').textContent = question.baseForm;
            document.getElementById('ruleResult').textContent = "?";
            
            const sentenceParts = document.getElementById('sentenceParts');
            sentenceParts.innerHTML = `
                <span class="sentence-part">Verb:</span>
                <span class="sentence-part">${question.baseForm}</span>
                <span class="sentence-part">‚Üí</span>
                <span class="sentence-blank">_____</span>
            `;
        }

        function showSituationQuestion(question) {
            document.getElementById('questionText').textContent = "Ho√†n th√†nh c√¢u d·ª±a v√†o t√¨nh hu·ªëng:";
            document.getElementById('situationContext').style.display = 'block';
            document.getElementById('situationText').textContent = question.situation;
            
            const subjectPart = document.getElementById('subjectPart');
            const verbPart = document.getElementById('verbPart');
            const objectPart = document.getElementById('objectPart');
            
            subjectPart.textContent = question.subject;
            verbPart.textContent = "_____";
            objectPart.textContent = question.object;
        }

        function showPictureQuestion(question) {
            document.getElementById('questionText').textContent = "M√¥ t·∫£ h√†nh ƒë·ªông trong h√¨nh:";
            document.getElementById('pictureContext').style.display = 'block';
            document.getElementById('pictureEmoji').textContent = question.emoji;
            document.getElementById('pictureDescription').textContent = question.description;
            
            const subjectPart = document.getElementById('subjectPart');
            const verbPart = document.getElementById('verbPart');
            const objectPart = document.getElementById('objectPart');
            
            subjectPart.textContent = question.subject;
            verbPart.textContent = "_____";
            objectPart.textContent = question.object;
        }

        function showQuestionFormQuestion(question) {
            document.getElementById('questionText').textContent = "Ho√†n th√†nh c√¢u h·ªèi:";
            
            const sentenceParts = document.getElementById('sentenceParts');
            sentenceParts.innerHTML = `
                <span class="sentence-blank">_____</span>
                <span class="sentence-part">${question.question.substring(question.question.indexOf(' ') + 1)}</span>
            `;
        }

        function createAnswerOptions(question) {
            const answerGrid = document.getElementById('answerGrid');
            answerGrid.innerHTML = '';
            
            question.options.forEach((option, index) => {
                const optionDiv = document.createElement('div');
                optionDiv.className = 'subject-option';
                optionDiv.onclick = () => selectAnswer(index);
                
                optionDiv.innerHTML = `<strong>${option}</strong>`;
                answerGrid.appendChild(optionDiv);
            });
        }

        function selectAnswer(selectedIndex) {
            if (isAnswered) return;
            
            isAnswered = true;
            const question = questions[currentQuestion];
            const options = document.querySelectorAll('.subject-option');
            
            // Remove previous classes
            options.forEach(option => {
                option.classList.remove('selected', 'correct', 'incorrect');
            });
            
            // Mark selected answer
            options[selectedIndex].classList.add('selected');
            
            if (selectedIndex === question.correct) {
                options[selectedIndex].classList.add('correct');
                correctAnswers++;
                score += calculateScore();
                streak++;
                maxStreak = Math.max(maxStreak, streak);
                
                // Update displays with correct answer
                updateCorrectAnswer(question);
                
            } else {
                options[selectedIndex].classList.add('incorrect');
                options[question.correct].classList.add('correct');
                streak = 0;
                
                updateCorrectAnswer(question);
            }
            
            // Show explanation
            document.getElementById('explanationText').textContent = question.explanation;
            document.getElementById('grammarRule').innerHTML = 
                `<strong>Quy t·∫Øc:</strong> ${question.rule}`;
            document.getElementById('explanationBox').style.display = 'block';
            document.getElementById('nextBtn').style.display = 'inline-block';
            document.getElementById('hintBtn').style.display = 'none';
        }

        function updateCorrectAnswer(question) {
            if (currentGameMode === 'ing-rules') {
                document.getElementById('ingForm').textContent = question.options[question.correct];
                document.getElementById('ruleResult').textContent = question.options[question.correct];
            } else if (currentGameMode === 'questions') {
                const sentenceParts = document.getElementById('sentenceParts');
                sentenceParts.innerHTML = `
                    <span class="sentence-part" style="background: #c8e6c9;">${question.options[question.correct]}</span>
                    <span class="sentence-part">${question.question.substring(question.question.indexOf(' ') + 1)}</span>
                `;
            } else {
                document.getElementById('verbPart').textContent = question.options[question.correct];
                document.getElementById('verbPart').style.background = '#c8e6c9';
                document.getElementById('verbPart').style.color = '#2e7d32';
            }
        }

        function calculateScore() {
            let baseScore = 10;
            if (streak > 2) baseScore += streak * 2;
            return baseScore;
        }

        function nextQuestion() {
            currentQuestion++;
            loadQuestion();
        }

        function showHint() {
            const hints = {
                'basics': "Nh·ªõ: I + am, He/She/It + is, You/We/They + are",
                'ing-rules': "Quy t·∫Øc: Th√¥ng th∆∞·ªùng +ing, k·∫øt th√∫c -e b·ªè e, CVC g·∫•p ƒë√¥i ph·ª• √¢m",
                'situations': "ƒê·ªçc k·ªπ t√¨nh hu·ªëng ƒë·ªÉ hi·ªÉu ai ƒëang l√†m g√¨",
                'pictures': "Quan s√°t h√¨nh ·∫£nh v√† m√¥ t·∫£ h√†nh ƒë·ªông ƒëang x·∫£y ra",
                'negative': "C√¢u ph·ªß ƒë·ªãnh: am/is/are + not + V-ing",
                'questions': "C√¢u h·ªèi: Am/Is/Are + ch·ªß ng·ªØ + V-ing?"
            };
            
            alert(hints[currentGameMode] || "ƒê·ªçc k·ªπ c√¢u h·ªèi v√† √°p d·ª•ng c√¥ng th·ª©c Present Continuous!");
        }

        function showIngRules() {
            const rules = `
Quy t·∫Øc th√™m -ing:
1. Th√¥ng th∆∞·ªùng: work ‚Üí working
2. K·∫øt th√∫c -e: write ‚Üí writing (b·ªè -e)
3. CVC (1 √¢m ti·∫øt): run ‚Üí running (g·∫•p ƒë√¥i)
4. K·∫øt th√∫c -ie: lie ‚Üí lying (ƒë·ªïi -ie th√†nh -y)
            `;
            alert(rules);
        }

        function endGame() {
            const accuracy = Math.round((correctAnswers / totalQuestions) * 100);
            
            document.getElementById('gamePlaySection').style.display = 'none';
            document.getElementById('gameResultsSection').style.display = 'block';
            
            // Show results
            document.getElementById('finalScore').textContent = score;
            document.getElementById('totalQuestions').textContent = totalQuestions;
            document.getElementById('correctAnswers').textContent = correctAnswers;
            document.getElementById('finalAccuracy').textContent = accuracy + '%';
            document.getElementById('maxStreak').textContent = maxStreak;
            
            // Show star rating
            showStarRating(accuracy);
            
            // Show achievements
            showFinalAchievements();
        }

        function showStarRating(accuracy) {
            const starContainer = document.getElementById('starRating');
            let stars = 0;
            
            if (accuracy >= 90) stars = 3;
            else if (accuracy >= 70) stars = 2;
            else if (accuracy >= 50) stars = 1;
            
            let starHTML = '';
            for (let i = 0; i < 3; i++) {
                starHTML += i < stars ? '‚≠ê' : '‚òÜ';
            }
            
            starContainer.innerHTML = `<div class="stars">${starHTML}</div>`;
        }

        function showFinalAchievements() {
            const achievements = [];
            
            if (correctAnswers === totalQuestions) {
                achievements.push("üéØ Perfect Continuous - Tr·∫£ l·ªùi ƒë√∫ng 100%!");
            }
            if (maxStreak >= 5) {
                achievements.push("üî• Continuous Master - " + maxStreak + " c√¢u ƒë√∫ng li√™n ti·∫øp!");
            }
            if (currentGameMode === 'ing-rules' && correctAnswers >= 8) {
                achievements.push("üìù Spelling Expert - Th√†nh th·∫°o quy t·∫Øc -ing!");
            }
            if (currentGameMode === 'pictures' && correctAnswers >= 8) {
                achievements.push("üì∏ Picture Master - M√¥ t·∫£ h√¨nh ·∫£nh xu·∫•t s·∫Øc!");
            }
            
            const achievementContainer = document.getElementById('achievementsDisplay');
            achievementContainer.innerHTML = achievements.length > 0 ? 
                '<h3>üèÜ Th√†nh T√≠ch</h3>' + achievements.map(a => `<div class="achievement">${a}</div>`).join('') : 
                '<p>Ti·∫øp t·ª•c luy·ªán t·∫≠p ƒë·ªÉ m·ªü kh√≥a th√†nh t√≠ch!</p>';
        }

        function resetGame() {
            document.getElementById('gameResultsSection').style.display = 'none';
            document.getElementById('gameModeSection').style.display = 'block';
        }

        function shuffleArray(array) {
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        }

        // Initialize default questions
        questions = shuffleArray(questionSets.basics);
    </script>
</body>
</html>
